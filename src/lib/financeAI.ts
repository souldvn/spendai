interface FinancialAnalysis {
  totalIncome: number;
  totalExpenses: number;
  expensesByCategory: Record<string, number>;
}

function getRecommendationsByCategory(category: string, amount: number, totalExpenses: number): string {
  const percentage = (amount / totalExpenses) * 100;
  
  const recommendations: Record<string, string[]> = {
    'Housing': [
      '‚Ä¢ –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ —Å–æ—Å–µ–¥–∞ –ø–æ –∫–≤–∞—Ä—Ç–∏—Ä–µ –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤',
      '‚Ä¢ –°—Ä–∞–≤–Ω–∏—Ç–µ —Ü–µ–Ω—ã –Ω–∞ –¥—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∂–∏–ª—å—è –≤ –≤–∞—à–µ–º —Ä–∞–π–æ–Ω–µ',
      '‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏'
    ],
    'Transport': [
      '‚Ä¢ –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞',
      '‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ carpooling –∏–ª–∏ —Å–æ–≤–º–µ—Å—Ç–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏',
      '‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–ø–ª–∏–≤–∞'
    ],
    'Food & Groceries': [
      '‚Ä¢ –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –º–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é –∑–∞—Ä–∞–Ω–µ–µ',
      '‚Ä¢ –ü–æ–∫—É–ø–∞–π—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ –∞–∫—Ü–∏—è–º –∏ —Å–æ —Å–∫–∏–¥–∫–∞–º–∏',
      '‚Ä¢ –ì–æ—Ç–æ–≤—å—Ç–µ –µ–¥—É –¥–æ–º–∞ –≤–º–µ—Å—Ç–æ –∑–∞–∫–∞–∑–æ–≤'
    ],
    'Entertainment': [
      '‚Ä¢ –ò—â–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è',
      '‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥—Ä—É–ø–ø–æ–≤—ã–µ —Å–∫–∏–¥–∫–∏ –∏ –∞–∫—Ü–∏–∏',
      '‚Ä¢ –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫–∏ –≤–º–µ—Å—Ç–æ —Ä–∞–∑–æ–≤—ã—Ö –ø–æ–∫—É–ø–æ–∫'
    ],
    'Shopping': [
      '‚Ä¢ –°–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –∏ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ—Å—å –µ–≥–æ',
      '‚Ä¢ –î–æ–∂–¥–∏—Ç–µ—Å—å —Å–µ–∑–æ–Ω–Ω—ã—Ö —Ä–∞—Å–ø—Ä–æ–¥–∞–∂',
      '‚Ä¢ –°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ —Ü–µ–Ω—ã –≤ —Ä–∞–∑–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–∞—Ö'
    ],
    'Health & Wellness': [
      '‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è',
      '‚Ä¢ –ó–∞–Ω–∏–º–∞–π—Ç–µ—Å—å —Å–ø–æ—Ä—Ç–æ–º –¥–æ–º–∞ –∏–ª–∏ –Ω–∞ —É–ª–∏—Ü–µ',
      '‚Ä¢ –ò—â–∏—Ç–µ —Å–∫–∏–¥–∫–∏ –Ω–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —É—Å–ª—É–≥–∏'
    ]
  };

  if (percentage > 30) {
    return `‚ö†Ô∏è –†–∞—Å—Ö–æ–¥—ã –Ω–∞ ${category} —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç ${percentage.toFixed(1)}% –æ—Ç –æ–±—â–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤.\n${
      recommendations[category]?.join('\n') || '‚Ä¢ –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤'
    }`;
  }
  
  return '';
}

export function analyzeFinances(data: FinancialAnalysis): string {
  const { totalIncome, totalExpenses, expensesByCategory } = data;
  const balance = totalIncome - totalExpenses;
  
  let analysis = "üìä –ê–Ω–∞–ª–∏–∑ –≤–∞—à–∏—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤:\n\n";
  
  // Basic overview
  analysis += `üí∞ –û–±—â–∏–π –¥–æ—Ö–æ–¥: $${totalIncome.toLocaleString()}\n`;
  analysis += `üí∏ –û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã: $${totalExpenses.toLocaleString()}\n`;
  analysis += `${balance >= 0 ? '‚úÖ' : '‚ö†Ô∏è'} –ë–∞–ª–∞–Ω—Å: $${balance.toLocaleString()}\n\n`;
  
  // Expenses by category
  analysis += "üìà –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:\n";
  Object.entries(expensesByCategory)
    .sort(([, a], [, b]) => b - a)
    .forEach(([category, amount]) => {
      const percentage = (amount / totalExpenses * 100).toFixed(1);
      analysis += `${category}: $${amount.toLocaleString()} (${percentage}%)\n`;
    });
  
  // Recommendations
  analysis += "\nüí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n";
  
  // Balance recommendations
  if (balance < 0) {
    analysis += "‚Ä¢ ‚ö†Ô∏è –í–∞—à–∏ —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –¥–æ—Ö–æ–¥—ã. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã –∏–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ—Ö–æ–¥.\n";
  } else if (balance < totalIncome * 0.2) {
    analysis += "‚Ä¢ ‚ö†Ô∏è –£ –≤–∞—Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–ø–∞—Å —Å—Ä–µ–¥—Å—Ç–≤. –ü–æ—Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å —É–≤–µ–ª–∏—á–∏—Ç—å —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è.\n";
  } else if (balance > totalIncome * 0.5) {
    analysis += "‚Ä¢ üí∞ –£ –≤–∞—Å —Ö–æ—Ä–æ—à–∏–π –∑–∞–ø–∞—Å —Å—Ä–µ–¥—Å—Ç–≤. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.\n";
  }

  // Category-specific recommendations
  Object.entries(expensesByCategory).forEach(([category, amount]) => {
    const recommendation = getRecommendationsByCategory(category, amount, totalExpenses);
    if (recommendation) {
      analysis += recommendation + "\n";
    }
  });

  // General recommendations
  if (totalExpenses > 0) {
    analysis += "\nüéØ –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n";
    analysis += "‚Ä¢ –°–æ–∑–¥–∞–π—Ç–µ –±—é–¥–∂–µ—Ç –Ω–∞ –º–µ—Å—è—Ü –∏ —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º\n";
    analysis += "‚Ä¢ –û—Ç–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ –º–∏–Ω–∏–º—É–º 20% –¥–æ—Ö–æ–¥–∞ –Ω–∞ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è\n";
    analysis += "‚Ä¢ –í–µ–¥–∏—Ç–µ —É—á–µ—Ç –≤—Å–µ—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è\n";
  }

  return analysis;
}

const commonResponses: Record<string, string> = {
  '–ø—Ä–∏–≤–µ—Ç': '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∞—à —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?',
  '–∫–∞–∫ —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å': '–í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±—â–∏—Ö —Å–æ–≤–µ—Ç–æ–≤ –ø–æ —ç–∫–æ–Ω–æ–º–∏–∏:\n‚Ä¢ –í–µ–¥–∏—Ç–µ —É—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤\n‚Ä¢ –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –ø–æ–∫—É–ø–∫–∏ –∑–∞—Ä–∞–Ω–µ–µ\n‚Ä¢ –ò—â–∏—Ç–µ —Å–∫–∏–¥–∫–∏ –∏ –∞–∫—Ü–∏–∏\n‚Ä¢ –°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ —Ü–µ–Ω—ã\n‚Ä¢ –û—Ç–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ —á–∞—Å—Ç—å –¥–æ—Ö–æ–¥–∞',
  '–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏': '–î–ª—è –Ω–∞—á–∞–ª–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∞–∂–Ω–æ:\n‚Ä¢ –°–æ–∑–¥–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –ø–æ–¥—É—à–∫—É\n‚Ä¢ –ò–∑—É—á–∏—Ç—å —Ä–∞–∑–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã\n‚Ä¢ –ù–µ —Ä–∏—Å–∫–æ–≤–∞—Ç—å –≤—Å–µ–º–∏ –¥–µ–Ω—å–≥–∞–º–∏\n‚Ä¢ –î–∏–≤–µ—Ä—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –≤–ª–æ–∂–µ–Ω–∏—è',
  '–±—é–¥–∂–µ—Ç': '–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±—é–¥–∂–µ—Ç–∞:\n‚Ä¢ 50% –Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–∞—Å—Ö–æ–¥—ã\n‚Ä¢ 30% –Ω–∞ –∂–µ–ª–∞–Ω–∏—è –∏ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è\n‚Ä¢ 20% –Ω–∞ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏',
};

export function getAIResponse(message: string, context: string): string {
  const lowerMessage = message.toLowerCase();
  
  // Check for common questions
  for (const [key, response] of Object.entries(commonResponses)) {
    if (lowerMessage.includes(key)) {
      return response;
    }
  }

  // Parse context for personalized response
  const contextData = context.split('\n').reduce((acc, line) => {
    const [key, value] = line.split(': $');
    if (value) {
      acc[key] = parseFloat(value.replace(/,/g, ''));
    }
    return acc;
  }, {} as Record<string, number>);

  // Personalized responses based on context
  if (lowerMessage.includes('–¥–æ–ª–≥') || lowerMessage.includes('–¥–æ–ª–≥–∏')) {
    const balance = contextData['Balance'] || 0;
    return balance < 0 
      ? '–î–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –¥–æ–ª–≥–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é:\n‚Ä¢ –°–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –ø–æ–≥–∞—à–µ–Ω–∏—è\n‚Ä¢ –°–æ–∫—Ä–∞—Ç–∏—Ç—å –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã\n‚Ä¢ –ò—Å–∫–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ—Ö–æ–¥–∞'
      : '–£ –≤–∞—Å –Ω–µ—Ç –¥–æ–ª–≥–æ–≤ - —ç—Ç–æ –æ—Ç–ª–∏—á–Ω–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å.';
  }

  if (lowerMessage.includes('—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è') || lowerMessage.includes('–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è')) {
    const income = contextData['Total Income'] || 0;
    return `–î–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å ${Math.round(income * 0.2)} –≤ –º–µ—Å—è—Ü (20% –æ—Ç –¥–æ—Ö–æ–¥–∞).\n–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –ø–æ–¥—É—à–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.`;
  }

  // Default response
  return '–Ø –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º —Å –∞–Ω–∞–ª–∏–∑–æ–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –∏ –¥–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –±—é–¥–∂–µ—Ç–æ–º. –ó–∞–¥–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–Ω–æ–ø–∫–æ–π "–ó–∞–ø—Ä–æ—Å–∏—Ç—å –∞–Ω–∞–ª–∏–∑" –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞.';
} 